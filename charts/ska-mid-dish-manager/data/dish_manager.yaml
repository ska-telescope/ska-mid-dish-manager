name: "dishmanager-{{ .Release.Name }}"
function: telescope-monitoring
domain: general-monitoring
command: "DishManagerDS"
server:
  name: "DishManagerDS"
  instances:
  {{- range .Values.coalesced_dishes }}
    {{- $dish := . | trim }}
    {{- $dishLower := $dish | lower }}
    {{- $receptorNumber := regexReplaceAll "[^0-9]" $dish "" }}
    - name: "{{ $dishLower }}"
      classes:
        - name: "DishManager"
          devices:
            - name: "mid-dish/dish-manager/{{ if regexMatch "^[0-9]+$" $dish }}SKA{{ $dish }}{{ else }}{{ $dishLower }}{{ end }}"
              properties:
                - name: "ReceptorNumber"
                  values:
                    - "{{ $receptorNumber }}"
                - name: "SkaLevel"
                  values:
                    - "1"
                - name: "LoggingTargetsDefault"
                  values:
                    - "tango::logger"
                - name: "LoggingLevelDefault"
                  values:
                    - "5"
                - name: "MaxCapabilities"
                  values:
                    - "BANDS:6"
                - name: "GroupDefinitions"
                  values:
                    - ""
                - name: "DSDeviceFqdn"
                  values:
                    {{- if $.Values.dishmanager.ds.fqdn }}
                    - "{{ $.Values.dishmanager.ds.fqdn }}"
                    {{- else }}
                    - "{{ $.Values.dishmanager.ds.domain_name }}/{{ $.Values.dishmanager.ds.family_name }}/{{ if regexMatch "^[0-9]+$" $dish }}SKA{{ $dish }}{{ else }}{{ $dishLower }}{{ end }}"
                    {{- end }}
                - name: "SPFDeviceFqdn"
                  values:
                    {{- if $.Values.dishmanager.spf.fqdn }}
                    - "{{ $.Values.dishmanager.spf.fqdn }}"
                    {{- else }}
                    - "{{ $.Values.dishmanager.spf.domain_name }}/{{ $.Values.dishmanager.spf.family_name }}/{{ if regexMatch "^[0-9]+$" $dish }}SKA{{ $dish }}{{ else }}{{ $dishLower }}{{ end }}"
                    {{- end }}
                - name: "SPFRxDeviceFqdn"
                  values:
                    {{- if $.Values.dishmanager.spfrx.fqdn }}
                    - "{{ $.Values.dishmanager.spfrx.fqdn }}"
                    {{- else }}
                    - "{{ $.Values.dishmanager.spfrx.domain_name }}/{{ $.Values.dishmanager.spfrx.family_name }}/{{ if regexMatch "^[0-9]+$" $dish }}SKA{{ $dish }}{{ else }}{{ $dishLower }}{{ end }}"
                    {{- end }}
                - name: "B5DCDeviceFqdn"
                  values:
                    {{- if $.Values.dishmanager.b5dcproxy.fqdn }}
                    - "{{ $.Values.dishmanager.b5dcproxy.fqdn }}"
                    {{- else }}
                    - "{{ $.Values.dishmanager.b5dcproxy.domain_name }}/{{ $.Values.dishmanager.b5dcproxy.family_name }}/{{ if regexMatch "^[0-9]+$" $dish }}SKA{{ $dish }}{{ else }}{{ $dishLower }}{{ end }}"
                    {{- end }}
                - name: "DishId"
                  values:
                    - "{{ if regexMatch "^[0-9]+$" $dish }}SKA{{ $dish }}{{ else }}{{ $dish | upper }}{{ end }}"
                - name: "DefaultWatchdogTimeout"
                  values:
                    - "{{ $.Values.dishmanager.watchdog.timeout_seconds }}"
                - name: "MeanWindSpeedThreshold"
                  values:
                    - "{{ $.Values.dishmanager.wms.MeanWindSpeedThreshold }}"
                - name: "WindGustThreshold"
                  values:
                    - "{{ $.Values.dishmanager.wms.WindGustThreshold }}"
                - name: "WMSDeviceNames"
                  values:
                    {{- range $.Values.dishmanager.wms.station_ids }}
                    - "ska-mid/weather-monitoring/{{ . }}"
                    {{- end }}
                - name: "DefaultActionTimeoutSeconds"
                  values:
                    - "{{ $.Values.dishmanager.actions.timeout_seconds }}"
              attribute_properties:
                - attribute: "ignoreSpf"
                  properties:
                    - name: "__value"
                      values:
                        - "{{ $.Values.dishmanager.spf.ignored }}"
                - attribute: "ignoreSpfrx"
                  properties:
                    - name: "__value"
                      values:
                        - "{{ $.Values.dishmanager.spfrx.ignored }}"
  {{- end }}
depends_on:
  - device: sys/database/2
image:
  registry: "{{ .Values.dishmanager.image.registry }}"
  image: "{{ .Values.dishmanager.image.image }}"
  tag: "{{ .Values.dishmanager.image.tag }}"
  pullPolicy: "{{ .Values.dishmanager.image.pullPolicy }}"
